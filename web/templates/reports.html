<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Reports - Money Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="app-layout" style="display: block; max-width: 1000px; padding-top: 2rem;">
        <header style="position: relative; margin-bottom: 2.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h1 style="margin: 0; color: #1f2937; text-shadow: none;">üìä Monthly Reports</h1>
                <a href="/"
                    style="text-decoration: none; background: white; color: var(--primary); padding: 0.6rem 1.2rem; border-radius: 0.75rem; font-weight: 600; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb; transition: all 0.2s;">
                    ‚Üê Back to Home
                </a>
            </div>
        </header>

        <main>
            <!-- Month Selector -->
            <section style="padding: 1.5rem; border-radius: 1.25rem; margin-bottom: 2rem;">
                <div style="display: flex; gap: 1.5rem; align-items: center; justify-content: center;">
                    <label style="font-weight: 700; color: #374151; font-size: 1rem;">Select Month:</label>
                    <input type="month" id="month-selector"
                        style="width: auto; padding: 0.6rem 1rem; border-radius: 0.75rem; border: 1px solid #e5e7eb; outline: none; font-size: 1rem; font-weight: 600; color: #1f2937; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <button id="load-report-btn"
                        style="width: auto; background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white; border: none; padding: 0.7rem 2rem; border-radius: 0.75rem; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); transition: all 0.2s;">
                        Load Report
                    </button>
                </div>
            </section>

            <!-- Summary Cards -->
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div class="summary-card"
                    style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 1.5rem; border-radius: 1rem; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Income</div>
                    <div id="total-income" style="font-size: 2rem; font-weight: 700;">0 ‚Ç´</div>
                </div>
                <div class="summary-card"
                    style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); padding: 1.5rem; border-radius: 1rem; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Expense</div>
                    <div id="total-expense" style="font-size: 2rem; font-weight: 700;">0 ‚Ç´</div>
                </div>
                <div class="summary-card"
                    style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); padding: 1.5rem; border-radius: 1rem; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Net Savings</div>
                    <div id="net-savings" style="font-size: 2rem; font-weight: 700;">0 ‚Ç´</div>
                </div>
                <div class="summary-card"
                    style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 1.5rem; border-radius: 1rem; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Transactions</div>
                    <div id="transaction-count" style="font-size: 2rem; font-weight: 700;">0</div>
                </div>
            </div>

            <!-- Charts -->
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                <!-- Category Breakdown -->
                <section
                    style="background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">
                    <h3 style="margin-bottom: 1rem;">Spending by Category</h3>
                    <div style="position: relative; height: 300px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </section>

                <!-- Top Categories -->
                <section
                    style="background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">
                    <h3 style="margin-bottom: 1rem;">Top Spending Categories</h3>
                    <div id="top-categories" style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <!-- Top categories will be inserted here -->
                    </div>
                </section>
            </div>

            <!-- Transaction List -->
            <section
                style="background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">
                <h3 style="margin-bottom: 1rem;">Transactions This Month</h3>
                <div id="monthly-transactions" style="max-height: 400px; overflow-y: auto;">
                    <!-- Transactions will be inserted here -->
                </div>
            </section>
        </main>
    </div>

    <script>
        // Helper functions
        function formatVND(num) {
            if (!num && num !== 0) return '';
            return Number(num).toLocaleString('vi-VN');
        }

        // Set default month: check localStorage, then fallback to current month
        const monthSelector = document.getElementById('month-selector');
        const savedMonth = localStorage.getItem('selectedMonth');
        const now = new Date();
        const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

        monthSelector.value = savedMonth || currentMonth;

        // Update localStorage when changed on this page too
        monthSelector.addEventListener('change', () => {
            localStorage.setItem('selectedMonth', monthSelector.value);
        });

        let categoryChart = null;

        // Load Report
        async function loadReport() {
            const month = monthSelector.value;
            if (!month) {
                alert('Please select a month');
                return;
            }

            try {
                const response = await fetch(`/api/monthly-report?month=${month}`);
                const data = await response.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                // Update summary cards
                document.getElementById('total-income').textContent = formatVND(data.summary.income) + ' ‚Ç´';
                document.getElementById('total-expense').textContent = formatVND(data.summary.expense) + ' ‚Ç´';
                document.getElementById('net-savings').textContent = formatVND(data.summary.net) + ' ‚Ç´';
                document.getElementById('transaction-count').textContent = data.summary.count;

                // Update category chart
                updateCategoryChart(data.spending_by_category);

                // Update top categories
                updateTopCategories(data.spending_by_category);

                // Update transactions list
                updateMonthlyTransactions(data.transactions);

            } catch (error) {
                console.error('Error loading report:', error);
                alert('Failed to load report');
            }
        }

        function updateCategoryChart(spendingData) {
            const ctx = document.getElementById('categoryChart').getContext('2d');

            const labels = Object.keys(spendingData);
            const values = Object.values(spendingData);

            const colors = ['#ef4444', '#f59e0b', '#10b981', '#6366f1', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];

            if (categoryChart) {
                categoryChart.data.labels = labels;
                categoryChart.data.datasets[0].data = values;
                categoryChart.update();
            } else {
                categoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }
        }

        function updateTopCategories(spendingData) {
            const container = document.getElementById('top-categories');

            // Sort by amount descending
            const sorted = Object.entries(spendingData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            if (sorted.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #9ca3af;">No expenses this month</p>';
                return;
            }

            const total = Object.values(spendingData).reduce((sum, val) => sum + val, 0);

            container.innerHTML = '';
            sorted.forEach(([category, amount], index) => {
                const percentage = (amount / total * 100).toFixed(1);
                const colors = ['#ef4444', '#f59e0b', '#10b981', '#6366f1', '#8b5cf6'];
                const color = colors[index % colors.length];

                const item = document.createElement('div');
                item.style.cssText = 'padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem; border-left: 4px solid ' + color;
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                        <strong>${category}</strong>
                        <span>${percentage}%</span>
                    </div>
                    <div style="font-size: 1.1rem; font-weight: 600; color: ${color};">
                        ${formatVND(amount)} ‚Ç´
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function updateMonthlyTransactions(transactions) {
            const container = document.getElementById('monthly-transactions');

            if (transactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 2rem;">No transactions this month</p>';
                return;
            }

            container.innerHTML = '';
            transactions.forEach(t => {
                const item = document.createElement('div');
                item.style.cssText = 'padding: 0.75rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;';
                item.innerHTML = `
                    <div>
                        <div style="font-weight: 600;">${t.category}</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">${t.date}</div>
                        ${t.description ? `<div style="font-size: 0.875rem; color: #9ca3af;">${t.description}</div>` : ''}
                    </div>
                    <div style="font-size: 1.1rem; font-weight: 600; color: ${t.type === 'expense' ? '#ef4444' : '#10b981'};">
                        ${t.type === 'expense' ? '-' : '+'}${formatVND(t.amount)} ‚Ç´
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // Event listeners
        document.getElementById('load-report-btn').addEventListener('click', loadReport);

        // Load current month on page load
        loadReport();
    </script>
</body>

</html>